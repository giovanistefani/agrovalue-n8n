{
  "name": "AgroValue - Processamento de Dados Meteorol√≥gicos",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/webhook/clima",
        "options": {}
      },
      "name": "Webhook - Dados Clima",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "functionCode": "// Processar dados meteorol√≥gicos\nconst dados = items[0].json;\n\n// Calcular √≠ndices agron√¥micos\nconst temperatura = dados.temperatura;\nconst umidade = dados.umidade;\nconst precipitacao = dados.precipitacao;\n\n// √çndice de conforto t√©rmico para gado\nconst ict = temperatura + (0.36 * umidade) + 41.2;\n\n// Risco de doen√ßas em plantas\nconst riscoDoenca = (umidade > 80 && temperatura > 20) ? 'Alto' : 'Baixo';\n\n// Necessidade de irriga√ß√£o\nconst necessidadeIrrigacao = precipitacao < 5 ? 'Sim' : 'N√£o';\n\nreturn [{\n  json: {\n    ...dados,\n    indices: {\n      conforto_termico_gado: ict,\n      risco_doenca_plantas: riscoDoenca,\n      necessidade_irrigacao: necessidadeIrrigacao,\n      data_processamento: new Date().toISOString()\n    }\n  }\n}];"
      },
      "name": "Function - Processar Dados",
      "type": "n8n-nodes-base.function",
      "typeVersion": 1,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.indices.risco_doenca_plantas}}",
              "value2": "Alto"
            }
          ]
        }
      },
      "name": "IF - Risco Alto",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "message": "‚ö†Ô∏è *Alerta AgroValue*\n\nüå°Ô∏è Risco alto de doen√ßas nas plantas detectado!\n\nüìä *Dados atuais:*\n‚Ä¢ Temperatura: {{$json.temperatura}}¬∞C\n‚Ä¢ Umidade: {{$json.umidade}}%\n‚Ä¢ Precipita√ß√£o: {{$json.precipitacao}}mm\n\nüîç *Recomenda√ß√µes:*\n‚Ä¢ Monitore as culturas de perto\n‚Ä¢ Considere aplica√ß√£o preventiva\n‚Ä¢ Verifique sistemas de ventila√ß√£o",
        "chatId": "{{$env.TELEGRAM_CHAT_ID}}",
        "parseMode": "Markdown"
      },
      "name": "Telegram - Alerta",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [
        900,
        200
      ],
      "credentials": {
        "telegramApi": {
          "id": "2",
          "name": "AgroValue Bot"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "table": "dados_meteorologicos",
        "columns": "timestamp, temperatura, umidade, precipitacao, ict, risco_doenca, necessidade_irrigacao",
        "additionalFields": {
          "mode": "independently"
        }
      },
      "name": "PostgreSQL - Salvar Dados",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 1,
      "position": [
        680,
        480
      ],
      "credentials": {
        "postgres": {
          "id": "1",
          "name": "AgroValue DB"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.indices.necessidade_irrigacao}}",
              "value2": "Sim"
            }
          ]
        }
      },
      "name": "IF - Irriga√ß√£o Necess√°ria",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        900,
        400
      ]
    },
    {
      "parameters": {
        "url": "https://api.sistema-irrigacao.com/ativar",
        "options": {
          "headers": {
            "Authorization": "Bearer {{$env.IRRIGACAO_API_TOKEN}}"
          },
          "body": {
            "setor": "{{$json.setor}}",
            "duracao": 30,
            "motivo": "Baixa precipita√ß√£o detectada"
          }
        },
        "httpMethod": "POST"
      },
      "name": "HTTP - Ativar Irriga√ß√£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [
        1120,
        400
      ]
    }
  ],
  "connections": {
    "Webhook - Dados Clima": {
      "main": [
        [
          {
            "node": "Function - Processar Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Function - Processar Dados": {
      "main": [
        [
          {
            "node": "IF - Risco Alto",
            "type": "main",
            "index": 0
          },
          {
            "node": "PostgreSQL - Salvar Dados",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF - Irriga√ß√£o Necess√°ria",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - Risco Alto": {
      "main": [
        [
          {
            "node": "Telegram - Alerta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF - Irriga√ß√£o Necess√°ria": {
      "main": [
        [
          {
            "node": "HTTP - Ativar Irriga√ß√£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {},
  "id": "2"
}
